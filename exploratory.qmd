---
title: "exploratory_spaghetti"
format: html
editor: visual
---

```{r}
pacman::p_load('tidyverse', 'here', 'janitor', 'indicspecies')
```

```{r}
catch_raw <- read_csv(here::here('data', 'catch_9218.csv'))

species_key <- read_csv(here::here('data', 'species_key.csv'), col_names = FALSE)




```

# Modify species key

```{r}
species_key_clean <- species_key[c(4,5),3:125] %>% 
  row_to_names(row_number = 1) %>% 
  clean_names() %>% 
  remove_empty(which = "rows") %>% 
  pivot_longer(cols = everything(),names_to = 'species_code', values_to = 'species_name')%>% 
  mutate(species_code = str_to_upper(species_code))%>%
  mutate(species_name = str_to_title(str_to_lower(species_name)))



```

# Clean_catch

```{r}
catch_clean <- catch_raw %>% 
  clean_names()

catch_clean$species_code[is.na(catch_clean$species_code)] <- 'NA'


```

# Top 10 species

```{r}
top_10_catch <- catch_clean %>%
  left_join(species_key_clean,
            by = "species_code") %>%
  group_by(species_name) %>%
  summarise(total_catch = sum(number, na.rm = TRUE)) %>%
  arrange(desc(total_catch)) %>%
  slice_head(n = 10) 

top_10_region <- catch_clean %>%
  left_join(species_key_clean,
            by = "species_code") %>%
 group_by(locale, species_name) %>%
  summarise(total_catch = sum(number, na.rm = TRUE), .groups = "drop") %>%
  arrange(locale, desc(total_catch)) %>%
  group_by(locale) %>%
  slice_head(n = 10) %>%  # top 10 per locale
  ungroup()

top_5_year <- catch_clean %>%
  left_join(species_key_clean,
            by = "species_code") %>%
 group_by(expr1, species_name) %>%
  summarise(total_catch = sum(number, na.rm = TRUE), .groups = "drop") %>%
  arrange(expr1, desc(total_catch)) %>%
  group_by(expr1) %>%
  slice_head(n = 5) %>%  # top 10 per locale
  ungroup()

five_best_year <- catch_clean %>%
  mutate(year = as.numeric(expr1)) %>%  # ensure numeric
  group_by(year) %>%
  summarise(total_catch = sum(number, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(total_catch)) %>%
  slice_head(n = 5)  # top 5 years by total catch



catch_plot <- catch_clean %>% 
  filter(species_code == 'NA' | species_code == 'ES') %>%  
  group_by(species_code, expr1, locale) %>% 
  summarize(count = sum(number)) %>% 
  pivot_wider(names_from = species_code,
              values_from = count) %>% 
  set_names(c('year', 'locale',  'english_sole', 'northern_anchovy'))
  
ggplot(catch_plot, aes(x = northern_anchovy, y = english_sole))+
  geom_point() +
  facet_wrap(~locale, scales = 'free')
```

```{r}
interaction <- catch_clean %>% 
  select(catch_info_trawl_id, species_code, number, locale) %>% 
  pivot_wider(names_from = species_code, values_from = number, values_fn = sum) %>% 
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% 
  filter(!locale == 'BLANK')
```


```{r}

group_vector <- interaction$locale

species_matrix <- as.matrix(interaction[, -c(1, 2)])
```

```{r}
indval <- multipatt(species_matrix, group_vector, 
                    control = how(nperm=999)) 
```

```{r}
summary(indval, alpha = .1)
```

